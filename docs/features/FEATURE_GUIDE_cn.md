# AgriFrost-AI 特征工程完整指南

<div align="center">

<img src="../logo/AgriFrost-AI-transparent.png" alt="AgriFrost-AI Logo" width="150"/>

</div>

**最后更新**: 2025-11-20

本文档整合了特征工程、QC字段处理、Jul特征说明和特征工程建议等所有相关内容，为特征工程提供一站式参考。

## 📋 目录

1. [特征概述](#特征概述)
2. [特征类别](#特征类别)
3. [特征实现](#特征实现)
4. [特征选择](#特征选择)
5. [QC字段处理](#qc字段处理)
6. [Jul特征详解](#jul特征详解)
7. [特征工程建议](#特征工程建议)
8. [性能对比](#性能对比)
9. [特征参考](#特征参考)

---

## 特征概述

### 特征统计

| 类别 | 数量 | 百分比 | 描述 |
|------|------|--------|------|
| **总特征** | **298** | **100%** | 所有工程化特征 |
| 滚动特征 | 180 | 60.4% | 滚动窗口统计 |
| 滞后特征 | 51 | 17.1% | 历史滞后值 |
| 站点特征 | 24 | 8.1% | 地理特征 |
| 时间特征 | 11 | 3.7% | 时间模式 |
| 派生特征 | 11 | 3.7% | 计算特征 |
| 风特征 | 7 | 2.3% | 风相关特征 |
| 湿度特征 | 6 | 2.0% | 湿度特征 |
| 辐射特征 | 3 | 1.0% | 太阳辐射 |
| 其他特征 | 3 | 1.0% | ETo, Precip, Vap Pres |
| 温度特征 | 2 | 0.7% | 气温/土壤温度 |

### 关键洞察

1. **滚动特征占主导** (60.4%): 捕获近期趋势和模式
2. **滞后特征重要** (17.1%): 捕获历史上下文
3. **站点特征显著** (8.1%): 捕获地理效应
4. **时间特征必需** (3.7%): 捕获时间模式
5. **派生特征有价值** (3.7%): 捕获物理关系

---

## 特征类别

### 1. 时间特征 (11)

时间特征捕获时间模式和季节周期。

**实现**: `create_time_features()` 在 `src/data/features/temporal.py`

**特征**:
- `hour`, `hour_cos`, `hour_sin` - 一天中的小时 (0-23)，循环编码
- `month`, `month_cos`, `month_sin` - 月份 (1-12)，循环编码
- `day_of_year` - 一年中的第几天 (1-366)
- `day_of_week` - 一周中的第几天 (0-6)
- `season` - 季节 (1=春季, 2=夏季, 3=秋季, 4=冬季)
- `is_night` - 夜间指示器 (18:00-06:00)

**目的**: 捕获昼夜和季节模式（夜间最冷，冬季）

### 2. 滞后特征 (51)

历史特定时间点的值。

**实现**: `create_lag_features()` 在 `src/data/features/lagging.py`

**滞后值**: 1h, 3h, 6h, 12h, 24h

**变量**: 气温、露点、ETo、降水、相对湿度、土壤温度、太阳辐射、风向、风速、水汽压

**示例**: `Air Temp (C)_lag_1`, `Air Temp (C)_lag_3`, ..., `Air Temp (C)_lag_24`

**目的**: 捕获影响当前条件的近期趋势和模式

### 3. 滚动特征 (180)

不同时间窗口上的滚动窗口统计（均值、最小值、最大值、标准差）。

**实现**: `create_rolling_features()` 在 `src/data/features/lagging.py`

**窗口**: 3h, 6h, 12h, 24h

**统计量**: mean, min, max, std, sum

**变量**: 与滞后特征相同（10个变量 × 4个窗口 × 5个函数 = 200个特征）- 20个派生滚动特征

**示例**: `Air Temp (C)_rolling_6h_mean`, `Air Temp (C)_rolling_24h_min`

**目的**: 通过统计聚合捕获近期趋势和模式

### 4. 站点特征 (24)

地理和站点特定特征。

**实现**: 从站点元数据合并

**特征**:
- `latitude`, `longitude`, `elevation` - 地理坐标
- `station_id` - 站点标识符
- 来自元数据的其他地理特征

**目的**: 捕获地理效应和空间模式

### 5. 派生特征 (11)

从原始变量计算的特征。

**示例**:
- `temp_dew_diff` - 温度减去露点
- `wind_chill` - 风寒指数
- `heat_index` - 热指数

**目的**: 捕获物理关系和交互

### 6. 其他特征类别

- **辐射特征 (3)**: 太阳辐射相关
- **风特征 (7)**: 风向和风速（带循环编码）
- **湿度特征 (6)**: 相对湿度和相关
- **温度特征 (2)**: 气温和土壤温度

---

## QC字段处理

### QC字段的作用

QC (Quality Control) 字段用于标记数据质量，过滤低质量数据。

#### QC标志含义

| QC标志 | 含义 | 处理方式 |
|--------|------|----------|
| `''` (空) | 高质量数据 | ✅ **保留原值** |
| `'Y'` | 中等异常但已接受 | ✅ **保留原值** |
| `'M'` | Missing (缺失数据) | ❌ **标记为NaN** |
| `'R'` | Rejected (极端异常值) | ❌ **标记为NaN** |
| `'S'` | Severe outlier (严重异常值) | ❌ **标记为NaN** |
| `'Q'` | Questionable (可疑数据) | ❌ **标记为NaN** |
| `'P'` | Provisional (临时数据) | ❌ **标记为NaN** |

### QC字段 **不作为** 模型特征

#### 原因

1. **数据类型不匹配**
   - QC列包含**字符串类型**的标志 (`'Y'`, `'M'`, `'R'`, `'S'`, `'Q'`, `'P'`)
   - 模型训练时，特征选择使用 `select_dtypes(include=[np.number])` 仅选择**数值型**特征
   - QC列不是数值型，**会被自动排除**

2. **语义不正确**
   - QC列是**质量控制标志**，不是**预测特征**
   - QC列只用于标记数据质量，不应用于预测目标变量

3. **会导致数据泄漏**
   - 如果QC列编码后作为特征，可能会包含未来信息（例如：`'P'` 标志可能表示数据是临时的，可能在未来被修改）
   - 这会导致不合理的性能提升

### 实际训练使用的特征（Raw Track）

训练时使用 `select_dtypes(include=[np.number])` **仅选择数值型特征**，因此实际训练使用的特征为：

1. ✅ `Hour (PST)`: 小时（数值型元数据）
2. ✅ `Jul`: 儒略日（数值型元数据）
3. ✅ `ETo (mm)`: 参考蒸散发（数值型）
4. ✅ `Precip (mm)`: 降水（数值型）
5. ✅ `Sol Rad (W/sq.m)`: 太阳辐射（数值型）
6. ✅ `Vap Pres (kPa)`: 水汽压（数值型）
7. ✅ `Air Temp (C)`: 气温（数值型）✅ **正确**：当前时刻温度用于预测未来温度
8. ✅ `Rel Hum (%)`: 相对湿度（数值型）
9. ✅ `Dew Point (C)`: 露点（数值型）
10. ✅ `Wind Speed (m/s)`: 风速（数值型）
11. ✅ `Wind Dir (0-360)`: 风向（数值型）
12. ✅ `Soil Temp (C)`: 土壤温度（数值型）

**总计: 12个数值型特征** ✅

**排除的特征**:
- 非数值型列: `Stn Name`, `CIMIS Region` (2个)
- QC列: `qc`, `qc.1`, ..., `qc.9` (10个，全部非数值型)

---

## Jul特征详解

### 什么是 'Jul'？

**`Jul`** 是 **Julian Day**（儒略日）的缩写，表示**一年中的第几天**（1-365 或 1-366）。

### 特征来源

`Jul` 来自原始 CIMIS 数据中的一个列，位于 `Hour (PST)` 之后，直接从 CIMIS 数据中提取。

### 为什么 'Jul' 特征重要？

#### 1. 季节性强

霜冻事件有明显的季节性规律：

| 季节 | Julian Day 范围 | 霜冻风险 |
|------|----------------|---------|
| **冬季** | 1-59, 334-365 | ⚠️ **高** |
| **春季** | 60-151 | ⚠️ 中等 |
| **夏季** | 152-243 | ✅ **低** |
| **秋季** | 244-333 | ⚠️ 中等 |

#### 2. 特征重要性高

在 Frost 分类任务中，`Jul` 是最重要的特征（**20.09%**），说明：

- ✅ **时间（季节）是预测霜冻的关键因素**
- ✅ **这符合物理常识**（霜冻主要发生在冬季）
- ✅ **季节性模式比单个气象变量更重要**

#### 3. 与其他时间特征的区别

- **`Jul` (Julian Day)**: 来自原始数据，连续数值，反映季节的渐进变化
- **`day_of_year`**: 在特征工程中从 `Date` 列计算得出，与 `Jul` 功能相同但名称不同
- **`month`**: 离散值（1-12），反映月份信息

---

## 特征实现

### 使用特征工程模块

```python
from src.data import DataPipeline
from pathlib import Path

# 从配置创建管道
pipeline = DataPipeline.from_config("config/pipeline/train.yaml")

# 处理数据
df_processed = pipeline.process(df_raw)
```

### 手动特征工程

```python
from src.data.features.temporal import create_time_features
from src.data.features.lagging import create_lag_features, create_rolling_features

# 时间特征
df = create_time_features(df, date_col="Date")

# 滞后特征
df = create_lag_features(
    df,
    columns=["Air Temp (C)", "Dew Point (C)", ...],
    lags=[1, 3, 6, 12, 24],
    groupby_col="Stn Id"
)

# 滚动特征
df = create_rolling_features(
    df,
    columns=["Air Temp (C)", "Dew Point (C)", ...],
    windows=[3, 6, 12, 24],
    stats=["mean", "min", "max", "std", "sum"],
    groupby_col="Stn Id"
)
```

### 重要注意事项

- **站点分组**: 滞后和滚动特征在每个站点组内计算
- **时间泄漏保护**: 使用正确的时间排序计算特征
- **缺失值处理**: 滚动特征使用 `min_periods=1`
- **循环编码**: 防止边界不连续性（小时 23 → 0，月份 12 → 1）

---

## 特征选择

### 累积重要性分析

基于训练模型的特征重要性分析：

| 特征数 | 累积重要性 | 推荐 |
|--------|-----------|------|
| Top 64 | 50.0% | 最小可行集 |
| **Top 136** | **80.0%** | **快速训练** |
| **Top 175** | **90.0%** | **⭐ 推荐** |
| **Top 206** | **95.0%** | **最佳性能** |
| Top 247 | 99.0% | 接近完整集 |
| All 280 | 100.0% | 完整特征集 |

### 推荐选项

#### Option 1: 快速训练 (Top 136, 80%)

**使用场景**: 生产环境、实时推理、资源受限系统

**优势**:
- ~50% 特征数量减少
- 更快计算
- 更低内存占用
- 更短训练时间

**权衡**: 可能丢失 10-20% 的细微模式

#### Option 2: 平衡 (Top 175, 90%) ⭐ **推荐**

**使用场景**: 大多数场景，标准训练

**优势**:
- 性能和效率的最优平衡
- 保留 90% 重要性
- 仅约 37% 特征数量减少
- 大多数任务的实用性能

**实现**:
```bash
python -m src.cli train single \
    --model-name lightgbm \
    --matrix-cell B \
    --track top175_features \
    --horizon-h 12 \
    --output-dir experiments/lightgbm_B_175f_12h
```

#### Option 3: 最佳性能 (Top 206, 95%)

**使用场景**: 最终模型训练，需要最大准确度

**优势**:
- 保留 95% 重要性
- 比 Top 175 更好的性能
- 仍然可管理的特征数量

#### Option 4: 完整集 (All 280)

**使用场景**: 最终评估，最大准确度，计算成本不是问题

**优势**:
- 最大可能的性能
- 保留所有有用特征

### 特征选择工作流

1. **训练初始模型** 使用所有特征
2. **分析特征重要性**: 检查模型输出目录中的 `feature_importance.csv`
3. **选择特征** 基于累积重要性:
   - Top 136 用于快速训练
   - Top 175 用于平衡（推荐）
   - Top 206 用于最佳性能
4. **使用选定特征重新训练** 使用适当的 track（例如 `top175_features`）

### 应该进一步减少特征吗？

**答案**: ❌ **不，大多数情况下不必要**

**原因**:
- **优秀的数据-特征比**: 2.36M 样本 / 298 特征 = **7,919:1**
- **行业标准**: > 1,000:1 是优秀的（我们有 7,919:1）
- **Top 175 特征** 已经提供最优平衡

**何时减少**:
- 资源约束
- 实时推理要求
- 需要进一步优化

---

## 特征工程建议

### 当前状况分析

| 项目 | 文档描述 | 实际使用 | 差异 |
|------|---------|---------|------|
| **特征总数** | 298 个 | 31 个（修复前） | -267 个 (-89.6%) |

### 问题诊断

#### 1. 配置问题

**当前配置问题**:
- `rolling_features.functions` 缺少 `"sum"`
- `lag_features.columns` 和 `rolling_features.columns` 设置为 `null`，可能只选择了部分列

**修复方案**:
```yaml
rolling_features:
  functions: ["mean", "min", "max", "std", "sum"]  # ✅ 添加 "sum"
lag_features:
  columns:  # ✅ 明确指定
    - "Air Temp (C)"
    - "Dew Point (C)"
    # ... 其他变量
rolling_features:
  columns:  # ✅ 明确指定
    - "Air Temp (C)"
    - "Dew Point (C)"
    # ... 其他变量
```

#### 2. 特征创建顺序

确保特征创建顺序正确：

1. **时间特征**（不依赖其他特征）
2. **站点特征**（不依赖其他特征）
3. **原始数值特征**（不依赖其他特征）
4. **派生特征**（可能依赖原始特征）
5. **滞后特征**（依赖原始和派生特征）
6. **滚动特征**（依赖原始和派生特征）
7. **高级特征**（依赖滞后和滚动特征）

### 修复后的预期特征数量

| 类别 | 修复前 | 修复后 | 增加 |
|------|--------|--------|------|
| **原始特征** | 12 | 12 | 0 |
| **时间特征** | ~11 | 11 | 0 |
| **滞后特征** | ~1 | 50 | +49 |
| **滚动特征** | ~0 | 180 | +180 |
| **派生特征** | ~3 | 11 | +8 |
| **其他特征** | ~15 | ~84 | +69 |
| **总计** | **~31** | **~298** | **+267** |

---

## 性能对比

### 特征集对比 (完整 vs Top 175)

基于 LightGBM 模型评估：

| Horizon | ROC-AUC (完整) | ROC-AUC (Top175) | MAE (完整) | MAE (Top175) | R² (完整) | R² (Top175) |
|---------|----------------|------------------|------------|--------------|-----------|-------------|
| 3h | 0.9965 | 0.9965 | 1.1548 | 1.1438 | 0.9698 | 0.9703 |
| 6h | 0.9928 | 0.9926 | 1.5853 | 1.5454 | 0.9458 | 0.9481 |
| 12h | 0.9892 | 0.9892 | 1.8439 | 1.7925 | 0.9270 | 0.9304 |
| 24h | 0.9827 | 0.9843 | 1.9562 | 1.9287 | 0.9171 | 0.9196 |

### 关键发现

- **ROC-AUC**: Top 175 相似或略好
- **MAE**: Top 175 略好（去除噪声）
- **R²**: Top 175 略好
- **结论**: Top 175 特征提供**最优性能**和**降低复杂度**

---

## 特征参考

### 快速参考表

#### 时间特征 (11)
- `hour`, `hour_cos`, `hour_sin` - 一天中的小时
- `month`, `month_cos`, `month_sin` - 月份
- `day_of_year` - 一年中的第几天
- `day_of_week` - 一周中的第几天
- `season` - 季节
- `is_night` - 夜间指示器

#### 滞后特征 (51)
- 变量: 气温、露点、ETo、降水、相对湿度、土壤温度、太阳辐射、风向、风速、水汽压
- 滞后值: 1h, 3h, 6h, 12h, 24h
- 格式: `{变量}_lag_{滞后小时数}`

#### 滚动特征 (180)
- 变量: 与滞后特征相同
- 窗口: 3h, 6h, 12h, 24h
- 统计量: mean, min, max, std, sum
- 格式: `{变量}_rolling_{窗口}h_{统计量}`

#### 站点特征 (24)
- `latitude`, `longitude`, `elevation`
- `station_id`
- 其他地理元数据

#### 派生特征 (11)
- `temp_dew_diff` - 温度减去露点
- `wind_chill` - 风寒指数
- `heat_index` - 热指数
- 其他计算特征

### 特征重要性洞察

**Top 10 最重要特征**（典型）:
1. `Air Temp (C)_rolling_6h_mean` - 近期温度趋势
2. `Air Temp (C)_lag_1` - 即时过去温度
3. `Dew Point (C)_rolling_6h_mean` - 近期露点趋势
4. `hour_cos` - 昼夜周期
5. `Air Temp (C)_rolling_24h_min` - 日最低值
6. `Dew Point (C)_lag_1` - 即时过去露点
7. `month_cos` - 季节周期
8. `Air Temp (C)_rolling_12h_mean` - 半天趋势
9. `latitude` - 地理效应
10. `Soil Temp (C)_rolling_6h_mean` - 近期土壤温度

### 实现细节

**代码位置**:
- 时间特征: `src/data/features/temporal.py`
- 滞后特征: `src/data/features/lagging.py`
- 滚动特征: `src/data/features/lagging.py`
- 站点特征: 从 `data/external/cimis_station_metadata.csv` 合并

**训练CLI**:
```bash
python -m src.cli train single \
    --model-name lightgbm \
    --matrix-cell B \
    --track top175_features \
    --horizon-h 12 \
    --output-dir experiments/model_dir
```

---

## 最佳实践

### 1. 特征选择

- ✅ 使用 **Top 175 特征** 用于大多数场景（推荐）
- ✅ 使用 **Top 136 特征** 用于快速训练/生产
- ✅ 使用 **Top 206 特征** 用于最佳性能
- ✅ 仅使用 **所有特征** 用于最终评估

### 2. 特征工程

- ✅ 始终按站点分组进行滞后/滚动特征计算
- ✅ 对时间特征使用循环编码
- ✅ 适当处理缺失值
- ✅ 防止时间泄漏

### 3. 模型训练

- ✅ 使用选定特征集（track 参数）训练
- ✅ 使用适当的矩阵单元格 (A/B/C/D/E)
- ✅ 在保留集上验证
- ✅ 如需要，对比不同特征集

---

## 相关文档

- **[用户指南](../guides/USER_GUIDE.md)**: 包含训练示例的用户指南
- **[特征重要性指南](./FEATURE_IMPORTANCE.md)**: 特征重要性分析和选择指南
- **[技术文档](../technical/TECHNICAL_DOCUMENTATION.md)**: 技术细节和API参考
- **[数据文档](../technical/DATA_DOCUMENTATION.md)**: 数据处理文档

---

**最后更新**: 2025-11-20  
**总特征数**: 298  
**推荐特征集**: Top 175 (90% 重要性)  
**文档版本**: 3.0

