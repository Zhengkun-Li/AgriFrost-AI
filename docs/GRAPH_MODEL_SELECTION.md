# 图神经网络模型选择建议 (Graph Neural Network Model Selection)

## 🎯 挑战特点分析

### 数据特点
- **站点数**: 18 个（相对较少）
- **时间粒度**: 小时级
- **数据量**: ~2.36M 行
- **类别不平衡**: Frost < 1%（极度不平衡）
- **预测任务**: 分类（frost probability）+ 回归（temperature）
- **Horizon**: 3h, 6h, 12h, 24h

### 空间关系
- **地理分布**: 集中在 San Joaquin Valley 区域
- **距离范围**: 25-100 km
- **空间相关性**: 中等（同一区域，但海拔差异大）

### 时间依赖
- **短期模式**: 3-6h（局部天气变化）
- **长期模式**: 12-24h（日周期、季节周期）
- **序列长度**: 24 小时（1天）

---

## 📊 模型分析与推荐

### 模型分类

#### 1. **纯图卷积模型**（空间建模为主）
- **ST-GCN** (Spatial-Temporal Graph Convolutional Network)
- **TGCN** (Temporal Graph Convolutional Network)
- **GAT** (Graph Attention Network)

#### 2. **图 + RNN 混合模型**（时空联合建模）
- **DCRNN** (Diffusion Convolutional Recurrent Neural Network)
- **GAT-LSTM / GAT-GRU** (Graph Attention + RNN)
- **GraphSAGE-LSTM** (Graph Sampling + LSTM)

#### 3. **图 + CNN 混合模型**（时空卷积）
- **GraphWaveNet** (Graph Convolution + WaveNet)
- **Conv-temporal (TCN-LSTM)** (1D-CNN + LSTM)

---

## 🔍 详细模型分析

### ⭐⭐⭐⭐⭐ **强烈推荐（Tier 1）**

#### 1. **DCRNN** (Diffusion Convolutional Recurrent Neural Network)
**适用性**: ⭐⭐⭐⭐⭐
**实现复杂度**: ⭐⭐⭐⭐
**训练时间**: ⭐⭐⭐⭐

**优点**:
- ✅ **专为时空预测设计**：扩散卷积捕捉空间依赖，RNN 捕捉时间依赖
- ✅ **适合小图**：18 个站点，DCRNN 在小图上表现优秀
- ✅ **可解释性强**：扩散过程有物理意义（温度传播）
- ✅ **成熟实现**：有 PyTorch Geometric 支持
- ✅ **适合多 horizon**：可以预测多个时间步

**缺点**:
- ⚠️ 需要预定义图结构（距离矩阵）
- ⚠️ 训练时间中等（比纯 RNN 慢）

**推荐理由**: 
- 最适合霜冻预测任务（温度扩散 + 时间序列）
- 在交通预测等时空任务上已验证有效

---

#### 2. **ST-GCN** (Spatial-Temporal Graph Convolutional Network)
**适用性**: ⭐⭐⭐⭐⭐
**实现复杂度**: ⭐⭐⭐
**训练时间**: ⭐⭐⭐

**优点**:
- ✅ **经典模型**：在动作识别等任务上广泛验证
- ✅ **时空分离**：空间卷积 + 时间卷积，结构清晰
- ✅ **实现简单**：有成熟的 PyTorch Geometric 实现
- ✅ **适合小图**：18 个站点，计算效率高
- ✅ **可扩展**：容易添加注意力机制

**缺点**:
- ⚠️ 时间建模相对简单（1D 卷积）
- ⚠️ 需要手动设计时间卷积核

**推荐理由**:
- 实现相对简单，适合快速验证
- 在时空任务上表现稳定

---

### ⭐⭐⭐⭐ **推荐（Tier 2）**

#### 3. **GAT-LSTM / GAT-GRU**
**适用性**: ⭐⭐⭐⭐
**实现复杂度**: ⭐⭐⭐⭐
**训练时间**: ⭐⭐⭐⭐

**优点**:
- ✅ **注意力机制**：可以学习站点间的重要性权重
- ✅ **灵活的空间建模**：GAT 可以学习动态空间关系
- ✅ **强时间建模**：LSTM/GRU 擅长捕捉长期依赖
- ✅ **适合不平衡数据**：注意力可以关注重要站点

**缺点**:
- ⚠️ 实现复杂度较高（需要组合两个模块）
- ⚠️ 训练时间较长（注意力计算开销）
- ⚠️ 超参数较多（注意力头数、LSTM 层数等）

**推荐理由**:
- 如果空间关系复杂（如风向影响），GAT 可以学习动态权重
- 适合需要可解释性的场景（注意力权重可视化）

---

#### 4. **GraphWaveNet**
**适用性**: ⭐⭐⭐⭐
**实现复杂度**: ⭐⭐⭐⭐⭐
**训练时间**: ⭐⭐⭐⭐⭐

**优点**:
- ✅ **WaveNet 架构**：擅长捕捉长期时间依赖
- ✅ **图卷积**：端到端学习空间关系
- ✅ **多尺度特征**：扩张卷积捕捉不同时间尺度
- ✅ **适合长 horizon**：24h 预测表现好

**缺点**:
- ⚠️ 实现复杂度高（需要实现 WaveNet 模块）
- ⚠️ 训练时间最长（多层扩张卷积）
- ⚠️ 内存占用大（需要存储多尺度特征）

**推荐理由**:
- 如果 24h horizon 预测是重点，GraphWaveNet 值得尝试
- 但实现和训练成本较高

---

### ⭐⭐⭐ **可选（Tier 3）**

#### 5. **TGCN** (Temporal Graph Convolutional Network)
**适用性**: ⭐⭐⭐
**实现复杂度**: ⭐⭐⭐
**训练时间**: ⭐⭐⭐

**优点**:
- ✅ **简单直接**：图卷积 + 时间卷积
- ✅ **计算效率高**：比 RNN 快
- ✅ **适合短期预测**：3-6h horizon

**缺点**:
- ⚠️ 时间建模能力有限（1D 卷积）
- ⚠️ 长期依赖捕捉不如 RNN

**推荐理由**:
- 可以作为 baseline，但可能不如 DCRNN/ST-GCN

---

#### 6. **GraphSAGE-LSTM**
**适用性**: ⭐⭐⭐
**实现复杂度**: ⭐⭐⭐⭐
**训练时间**: ⭐⭐⭐⭐

**优点**:
- ✅ **采样机制**：适合大图（虽然我们只有 18 个站点）
- ✅ **归纳学习**：可以处理新站点

**缺点**:
- ⚠️ 对于小图（18 个站点），采样优势不明显
- ⚠️ 实现复杂度较高

**推荐理由**:
- 如果未来要扩展到更多站点，可以考虑
- 当前 18 个站点，优势不明显

---

#### 7. **Conv-temporal (TCN-LSTM)**
**适用性**: ⭐⭐⭐
**实现复杂度**: ⭐⭐⭐⭐
**训练时间**: ⭐⭐⭐⭐

**优点**:
- ✅ **1D-CNN 捕捉模式**：可以捕捉局部时间模式
- ✅ **LSTM 捕捉长期依赖**：结合两者优势
- ✅ **站点维度卷积**：如果按站点排列，可以捕捉站点间模式

**缺点**:
- ⚠️ 不是真正的图模型（没有显式图结构）
- ⚠️ 空间建模能力有限（依赖数据排列）

**推荐理由**:
- 可以作为过渡方案（从序列模型到图模型）
- 但不如真正的图模型（DCRNN/ST-GCN）

---

## 🎯 最终推荐方案

### 方案 1：最小可行方案（MVP）
**选择 2 个模型**:
1. **DCRNN** - 主要模型（时空联合建模）
2. **ST-GCN** - Baseline 对比（经典时空图模型）

**理由**:
- DCRNN 最适合霜冻预测（温度扩散）
- ST-GCN 作为对比，实现简单
- 两个模型互补（RNN vs CNN）

**预计时间**:
- DCRNN: ~60 分钟/horizon
- ST-GCN: ~40 分钟/horizon
- 总计: ~6.7 小时（4 horizon × 2 模型）

---

### 方案 2：完整方案（Full）
**选择 4 个模型**:
1. **DCRNN** - 主要模型
2. **ST-GCN** - Baseline
3. **GAT-LSTM** - 注意力机制（如果空间关系复杂）
4. **GraphWaveNet** - 长期依赖（如果 24h 预测重要）

**理由**:
- 覆盖不同架构（RNN, CNN, Attention, WaveNet）
- 可以对比不同建模方式的效果

**预计时间**:
- DCRNN: ~60 分钟/horizon
- ST-GCN: ~40 分钟/horizon
- GAT-LSTM: ~70 分钟/horizon
- GraphWaveNet: ~90 分钟/horizon
- 总计: ~17.3 小时（4 horizon × 4 模型）

---

### 方案 3：扩展方案（Extended）
**选择 6 个模型**:
1. **DCRNN** - 主要模型
2. **ST-GCN** - Baseline
3. **GAT-LSTM** - 注意力
4. **GraphWaveNet** - 长期依赖
5. **TGCN** - 简单对比
6. **GAT-GRU** - 与 GAT-LSTM 对比

**预计时间**: ~25 小时

---

## 📋 实现优先级

### Phase 1: 核心实现（必须）
1. **DCRNN** ⭐⭐⭐⭐⭐
   - 最适合霜冻预测
   - 有成熟实现参考
   - 预计实现时间: 2-3 天

2. **ST-GCN** ⭐⭐⭐⭐
   - 经典 baseline
   - 实现相对简单
   - 预计实现时间: 1-2 天

### Phase 2: 扩展实现（推荐）
3. **GAT-LSTM** ⭐⭐⭐⭐
   - 如果 DCRNN/ST-GCN 表现好，可以尝试
   - 预计实现时间: 2-3 天

4. **GraphWaveNet** ⭐⭐⭐
   - 如果 24h 预测是重点
   - 预计实现时间: 3-4 天

### Phase 3: 可选实现（时间允许）
5. **TGCN** ⭐⭐⭐
6. **GraphSAGE-LSTM** ⭐⭐⭐
7. **Conv-temporal** ⭐⭐

---

## 🔧 实现建议

### 1. 图结构构建
```python
# 基于距离的图
- 半径图: R ∈ {25, 50, 75, 100} km
- kNN 图: k ∈ {3, 5, 7}
- 边权: 距离衰减（高斯核）或可学习
```

### 2. 节点特征
```python
# Raw 变量 + 时间编码
- 原始气象变量（温度、湿度、风速等）
- 时间编码（hour_sin/cos, day_sin/cos, season）
- 不走 FE（保持 E 类别定义）
```

### 3. 训练配置
```python
# 复用 LSTM 的训练逻辑
- AMP (混合精度)
- 早停 (Early Stopping)
- LR 调度
- 不平衡数据处理（pos_weight, Focal Loss）
- 概率校准
```

### 4. 评估指标
```python
# 与 A/B/C/D 保持一致
- 分类: ROC-AUC, PR-AUC, Brier Score, ECE
- 回归: MAE, RMSE, R²
- LOSO 评估
```

---

## 📊 模型对比表

| 模型 | 适用性 | 复杂度 | 训练时间 | 空间建模 | 时间建模 | 推荐度 |
|------|--------|--------|----------|----------|----------|--------|
| **DCRNN** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | 扩散卷积 | RNN | ⭐⭐⭐⭐⭐ |
| **ST-GCN** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ | 图卷积 | 1D 卷积 | ⭐⭐⭐⭐⭐ |
| **GAT-LSTM** | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | 注意力 | RNN | ⭐⭐⭐⭐ |
| **GraphWaveNet** | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | 图卷积 | WaveNet | ⭐⭐⭐⭐ |
| **TGCN** | ⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ | 图卷积 | 1D 卷积 | ⭐⭐⭐ |
| **GraphSAGE-LSTM** | ⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | 采样 | RNN | ⭐⭐⭐ |
| **Conv-temporal** | ⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | 隐式 | CNN+RNN | ⭐⭐⭐ |

---

## 🎯 最终建议

### 推荐方案：**方案 1（MVP）**
- **DCRNN** + **ST-GCN**
- 理由：两个模型互补，覆盖主要架构，实现和训练成本合理

### 如果时间允许：**方案 2（Full）**
- 添加 **GAT-LSTM** 和 **GraphWaveNet**
- 理由：更全面的对比，但需要更多实现和训练时间

### 不推荐：
- **GraphSAGE-LSTM**: 18 个站点太小，采样优势不明显
- **Conv-temporal**: 不是真正的图模型，不如 DCRNN/ST-GCN
- **TGCN**: 可以作为 baseline，但不如 DCRNN/ST-GCN

---

## 📝 实现检查清单

### DCRNN
- [ ] 图结构构建（距离矩阵）
- [ ] 扩散卷积层实现
- [ ] RNN 层（LSTM/GRU）
- [ ] 多 horizon 预测
- [ ] 与 BaseModel 接口对齐

### ST-GCN
- [ ] 图结构构建
- [ ] 空间图卷积
- [ ] 时间卷积
- [ ] 残差连接
- [ ] 与 BaseModel 接口对齐

### 通用
- [ ] 图结构缓存（`data/interim/graph/{R|k}.pkl`）
- [ ] 训练逻辑复用（AMP, 早停, 校准等）
- [ ] LOSO 评估支持
- [ ] 结果落盘（E 类别目录结构）

---

*最后更新: 2025-11-16*
*基于挑战特点和模型特性分析*

